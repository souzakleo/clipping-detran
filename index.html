<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Clipping Detran-MA</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#eef2f7; --card:#fff; --text:#0f172a; --muted:#64748b;
      --primary:#2563eb; --primary2:#0ea5e9; --border:#cbd5e1;
      --shadow:0 6px 18px rgba(2,6,23,.08); --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;font-family:Segoe UI,system-ui,Arial;background:var(--bg);color:var(--text);}
    .container{max-width:1750px;margin:0 auto;}
    .header{
      background:linear-gradient(135deg,#1e40af,var(--primary2));
      color:#fff;padding:18px 20px;border-radius:var(--radius);
      box-shadow:var(--shadow);margin-bottom:18px;
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .header h1{margin:0;font-size:22px}
    .header .sub{font-size:12px;opacity:.9;margin-top:4px}
    .pill{font-size:12px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.22);
      padding:8px 10px;border-radius:999px;white-space:nowrap;display:inline-flex;gap:8px;align-items:center;}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:18px;}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:end;}
    .field{display:flex;flex-direction:column;gap:6px;min-width:190px}
    .field label{font-size:12px;color:var(--muted)}
    select,input{padding:10px;border-radius:12px;border:1px solid var(--border);background:#fff;font-size:14px;outline:none}
    button{padding:10px 12px;border-radius:12px;border:1px solid transparent;background:var(--primary);color:#fff;cursor:pointer;font-weight:600}
    button.secondary{background:#fff;color:var(--primary);border-color:var(--border)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap}
    .status{font-size:12px;color:var(--muted);margin-top:8px}
    .status.ok{color:#0f766e}
    .status.err{color:#b91c1c}

    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:18px;}
    .kpi{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff;border-radius:var(--radius);
      box-shadow:var(--shadow);padding:14px;min-height:92px;display:flex;flex-direction:column;gap:6px}
    .kpi .label{font-size:12px;opacity:.9}
    .kpi .value{font-size:26px;font-weight:800;line-height:1}
    .kpi .hint{font-size:12px;opacity:.9}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:14px;margin-bottom:18px;}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px;border-radius:12px;overflow:hidden;border:1px solid #e2e8f0}
    thead th{background:var(--primary);color:#fff;text-align:left;padding:10px;font-weight:700;position:sticky;top:0}
    tbody td{padding:9px 10px;border-top:1px solid #e2e8f0;vertical-align:top}
    tbody tr:hover{background:#f8fafc}
    .tablewrap{max-height:520px;overflow:auto;border-radius:12px}

    a.titlelink{color:#0f172a;text-decoration:none;font-weight:650}
    a.titlelink:hover{color:var(--primary);text-decoration:underline}
  </style>
</head>

<body>
<div class="container">

  <div class="header">
    <div>
      <h1>Clipping Detran-MA</h1>
      <div class="sub">Base Geral (2025 a 2026)</div>
    </div>
    <div class="pill">
      <span>üìÑ</span>
      <span>Busca + Filtros + Gr√°ficos</span>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <div class="field" style="min-width:260px;flex:1">
        <label>Buscar no t√≠tulo</label>
        <input id="busca" type="text" placeholder="Ex: blitz, campanha, CNH..." />
      </div>

      <div class="field">
        <label>Data inicial</label>
        <input id="dataIni" type="date" />
      </div>

      <div class="field">
        <label>Data final</label>
        <input id="dataFim" type="date" />
      </div>

      <div class="field">
        <label>Impacto</label>
        <select id="fImpacto"></select>
      </div>

      <div class="field">
        <label>Ve√≠culos</label>
        <select id="fVeiculo"></select>
      </div>

      <div class="field">
        <label>Local (pra√ßa)</label>
        <select id="fPraca"></select>
      </div>

      <div class="btnrow">
        <button id="btnCarregar">Carregar</button>
        <button class="secondary" id="btnFiltrar">Filtrar</button>
        <button class="secondary" id="btnLimpar">Limpar</button>
      </div>
    </div>

    <div id="status" class="status">
      Clique em <b>Carregar</b> para buscar os dados.
    </div>
  </div>

  <div class="kpis">
    <div class="kpi">
      <div class="label">Total de mat√©rias</div>
      <div class="value" id="kTotal">0</div>
      <div class="hint">na sele√ß√£o atual</div>
    </div>
    <div class="kpi">
      <div class="label" id="kImpactoLabel">% Positivas</div>
      <div class="value" id="kImpactoPct">0%</div>
      <div class="hint" id="kImpactoHint">impacto ‚ÄúPositivo‚Äù</div>
    </div>
    <div class="kpi">
      <div class="label">Top Ve√≠culo</div>
      <div class="value" id="kVeiculo">-</div>
      <div class="hint">maior volume</div>
    </div>
    <div class="kpi">
      <div class="label">Top T√≥pico</div>
      <div class="value" id="kTopico">-</div>
      <div class="hint">maior volume</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3 style="margin:0 0 10px 0;font-size:15px;">Impacto</h3>
      <canvas id="gImpacto"></canvas>
    </div>
    <div class="card">
      <h3 style="margin:0 0 10px 0;font-size:15px;">T√≥picos</h3>
      <canvas id="gTopico"></canvas>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;font-size:15px;">Lista de mat√©rias</h3>
    <div class="tablewrap">
      <table>
        <thead>
          <tr>
            <th style="width:38%">T√≠tulo</th>
            <th style="width:12%">Data</th>
            <th style="width:18%">Ve√≠culo</th>
            <th style="width:12%">Impacto</th>
            <th style="width:20%">Local (pra√ßa)</th>
          </tr>
        </thead>
        <tbody id="tb">
          <tr><td colspan="5">Sem dados</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ‚úÖ Seu link CSV (BASE_GERAL) */
const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQDEoRILXzO3X3rUuRZJV8VaMFuxgiyaqqJbVe7wpEeOxYkoTV1Tl9oWNyK9z4vxCSCdI0Yrbxve_6/pub?gid=553568239&single=true&output=csv";

let rows = [];       // linhas normalizadas (chaves fixas)
let base = [];       // base sem impacto (para KPI %)
let filtrados = [];  // base com impacto (para tabela/gr√°fico)
let charts = {};

const $ = (id) => document.getElementById(id);

function setStatus(msg, kind=""){
  const el = $("status");
  el.className = "status" + (kind ? " " + kind : "");
  el.innerHTML = msg;
}

function stripAccents(s){
  return (s ?? "").toString()
    .replace(/^\uFEFF/, "")            // remove BOM
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}
function keyNorm(s){
  return stripAccents(s)
    .trim()
    .toLowerCase()
    .replace(/\s+/g,"")
    .replace(/[^a-z0-9]/g,"");         // remove par√™nteses e s√≠mbolos
}
function cap1(s){
  const v = (s ?? "").toString().trim();
  if(!v) return "";
  return v.charAt(0).toUpperCase() + v.slice(1);
}

/* Mapeia cabe√ßalhos reais -> campos can√¥nicos usando "cont√©m" */
function buildHeaderMap(sampleRow){
  const keys = Object.keys(sampleRow || {});
  const map = {}; // canon -> realKey
  const normKeys = keys.map(k => ({ raw:k, nk:keyNorm(k) }));

  const want = {
    titulo:  ["titulo","materia","noticia"],
    data:    ["data","date"],
    topico:  ["topico","assunto","tema"],
    impacto: ["impacto","sentimento"],
    veiculo: ["veiculo","fonte","midia"],
    praca:   ["localpraca","praca","local","cidade","municipio"],
    link:    ["link","url","endereco"]
  };

  // procura por "igual" ou "cont√©m"
  for(const canon of Object.keys(want)){
    for(const alt of want[canon]){
      const a = keyNorm(alt);
      const found = normKeys.find(k => k.nk === a) || normKeys.find(k => k.nk.includes(a) || a.includes(k.nk));
      if(found){ map[canon] = found.raw; break; }
    }
  }
  return map;
}

function pick(row, map, canon){
  const rk = map[canon];
  return rk ? (row[rk] ?? "") : "";
}

/* Datas */
function parseDateAny(s){
  const v = (s ?? "").toString().trim();
  if(!v) return null;

  if(/^\d{4}-\d{2}-\d{2}/.test(v)){
    const d = new Date(v.slice(0,10) + "T00:00:00");
    return isNaN(d) ? null : d;
  }
  const m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m){
    const dd = parseInt(m[1],10);
    const mm = parseInt(m[2],10)-1;
    const yy = parseInt(m[3],10);
    const d = new Date(yy,mm,dd);
    return isNaN(d) ? null : d;
  }
  const d = new Date(v);
  return isNaN(d) ? null : d;
}
function parseDateInput(id){
  const v = $(id).value;
  if(!v) return null;
  const d = new Date(v + "T00:00:00");
  return isNaN(d) ? null : d;
}
function inRange(dt, ini, fim){
  if(!ini && !fim) return true;
  if(!dt) return false;
  const t = dt.getTime();
  if(ini && t < ini.getTime()) return false;
  if(fim && t > fim.getTime()) return false;
  return true;
}

/* Selects */
function distinct(col){
  return [...new Set(rows.map(r => cap1(r[col])).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"pt-BR"));
}
function preencherSelect(id, col){
  const el = $(id);
  const vals = distinct(col);
  el.innerHTML = `<option value="">Todos</option>` + vals.map(v=>`<option value="${escapeAttr(v)}">${escapeHtml(v)}</option>`).join("");
}

/* Agrega√ß√µes */
function contar(arr, col){
  const c = {};
  for(const r of arr){
    const v = cap1(r[col]) || "Sem dado";
    c[v] = (c[v] || 0) + 1;
  }
  return c;
}
function top(obj){
  const e = Object.entries(obj).sort((a,b)=>b[1]-a[1])[0];
  return e ? e[0] : "-";
}

/* Gr√°ficos */
const palette = ["#2563eb","#0ea5e9","#22c55e","#f59e0b","#ef4444","#a855f7","#14b8a6","#fb7185","#84cc16","#f97316"];
function plot(id, data, type){
  if(charts[id]) charts[id].destroy();
  const labels = Object.keys(data);
  const values = Object.values(data);
  const colors = labels.map((_,i)=>palette[i%palette.length]);

  charts[id] = new Chart($(id),{
    type,
    data:{ labels, datasets:[{ data: values, backgroundColor: type==="bar" ? colors[0] : colors }] },
    options:{
      responsive:true,
      plugins:{ legend:{ display: type!=="bar" } },
      scales: type==="bar" ? { y:{ beginAtZero:true } } : {}
    }
  });
}

function render(){
  $("kTotal").textContent = String(filtrados.length);

  const imSel = $("fImpacto").value || "Positivo";
  const label = $("fImpacto").value ? `% ${imSel}` : "% Positivas";

  const baseTotal = base.length;
  const impBase = contar(base, "impacto");
  const alvo = impBase[imSel] || 0;
  const pct = baseTotal ? Math.round((alvo/baseTotal)*100) : 0;

  $("kImpactoLabel").textContent = label;
  $("kImpactoPct").textContent = `${pct}%`;
  $("kImpactoHint").textContent = `base: ${baseTotal} ‚Ä¢ impacto ‚Äú${imSel}‚Äù`;

  $("kVeiculo").textContent = top(contar(filtrados,"veiculo"));
  $("kTopico").textContent = top(contar(filtrados,"topico"));

  plot("gImpacto", contar(filtrados,"impacto"), "pie");
  plot("gTopico", contar(filtrados,"topico"), "bar");

  const tb = $("tb");
  if(filtrados.length === 0){
    tb.innerHTML = `<tr><td colspan="5">Sem dados</td></tr>`;
    return;
  }
  tb.innerHTML = filtrados.map(r=>{
    const titulo = (r.titulo || "").toString();
    const link = (r.link || "").toString().trim();
    return `
      <tr>
        <td>${link ? `<a class="titlelink" href="${escapeAttr(link)}" target="_blank" rel="noopener">${escapeHtml(titulo)}</a>` : escapeHtml(titulo)}</td>
        <td>${escapeHtml(r.dataStr || "")}</td>
        <td>${escapeHtml(cap1(r.veiculo))}</td>
        <td>${escapeHtml(cap1(r.impacto))}</td>
        <td>${escapeHtml(cap1(r.praca))}</td>
      </tr>
    `;
  }).join("");
}

function aplicarFiltros(silent=false){
  const q = $("busca").value.toLowerCase();
  const di = parseDateInput("dataIni");
  const df = parseDateInput("dataFim");
  const ve = $("fVeiculo").value;
  const pr = $("fPraca").value;
  const im = $("fImpacto").value;

  base = rows.filter(r=>{
    const titulo = (r.titulo || "").toString().toLowerCase();
    return (!q || titulo.includes(q)) &&
      (!ve || cap1(r.veiculo) === ve) &&
      (!pr || cap1(r.praca) === pr) &&
      inRange(r._dateObj, di, df);
  });

  filtrados = base.filter(r=> !im || cap1(r.impacto) === im);

  render();
  if(!silent){
    setStatus(`Filtro aplicado. Base: <b>${base.length}</b> ‚Ä¢ Exibindo: <b>${filtrados.length}</b>`, "ok");
  }
}

function carregar(){
  $("btnCarregar").disabled = true;
  setStatus("Carregando CSV‚Ä¶", "");

  Papa.parse(URL_CSV, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete: (res)=>{
      const data = res.data || [];
      if(!data.length){
        $("btnCarregar").disabled = false;
        setStatus("O CSV veio vazio. Verifique se a BASE_GERAL tem dados abaixo do cabe√ßalho.", "err");
        return;
      }

      const headerMap = buildHeaderMap(data[0]);
      console.log("HeaderMap:", headerMap);

      // Normaliza para chaves fixas
      rows = data.map(row=>{
        const titulo = pick(row, headerMap, "titulo");
        const dataStr = pick(row, headerMap, "data");
        return {
          titulo,
          dataStr,
          _dateObj: parseDateAny(dataStr),
          topico: pick(row, headerMap, "topico"),
          impacto: pick(row, headerMap, "impacto"),
          veiculo: pick(row, headerMap, "veiculo"),
          praca: pick(row, headerMap, "praca"),
          link: pick(row, headerMap, "link"),
        };
      }).filter(r => (r.titulo ?? "").toString().trim().length > 0);

      if(rows.length === 0){
        $("btnCarregar").disabled = false;
        setStatus("Carregou, mas nenhuma linha foi reconhecida como mat√©ria (T√≠tulo vazio). Confirme se h√° t√≠tulos preenchidos.", "err");
        return;
      }

      preencherSelect("fImpacto","impacto");
      preencherSelect("fVeiculo","veiculo");
      preencherSelect("fPraca","praca");

      aplicarFiltros(true);

      $("btnCarregar").disabled = false;
      setStatus(`Dados carregados: <b>${rows.length}</b> mat√©rias.`, "ok");
    },
    error: (err)=>{
      console.error(err);
      $("btnCarregar").disabled = false;
      setStatus("Falha ao buscar o CSV. Abra o Console (F12) para ver o erro.", "err");
    }
  });
}

/* Escape */
function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeAttr(str){ return escapeHtml(str).replaceAll("`","&#096;"); }

/* Eventos */
$("btnCarregar").addEventListener("click", carregar);
$("btnFiltrar").addEventListener("click", ()=>aplicarFiltros(false));
$("btnLimpar").addEventListener("click", ()=>{
  $("busca").value = "";
  $("dataIni").value = "";
  $("dataFim").value = "";
  $("fImpacto").value = "";
  $("fVeiculo").value = "";
  $("fPraca").value = "";
  aplicarFiltros(true);
  setStatus(`Filtros limpos. Exibindo: <b>${filtrados.length}</b>`, "ok");
});

$("busca").addEventListener("keydown",(e)=>{ if(e.key==="Enter") aplicarFiltros(false); });
["fImpacto","fVeiculo","fPraca","dataIni","dataFim"].forEach(id=>{
  $(id).addEventListener("change", ()=>aplicarFiltros(true));
});
</script>
</body>
</html>
