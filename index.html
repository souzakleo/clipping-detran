<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Clipping Detran-MA</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#eef2f7; --card:#fff; --text:#0f172a; --muted:#64748b;
  --primary:#2563eb; --primary2:#0ea5e9; --border:#cbd5e1;
  --shadow:0 6px 18px rgba(2,6,23,.08); --radius:14px;
}
body{margin:0;padding:20px;font-family:Segoe UI,system-ui,Arial;background:var(--bg);color:var(--text);}
.container{max-width:1750px;margin:auto;}

.header{
  background:linear-gradient(135deg,#1e40af,#0ea5e9);
  color:#fff;
  padding:14px 20px;
  border-radius:14px;
  box-shadow:var(--shadow);
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
  gap:12px;
}
.header-title{font-size:22px;font-weight:800;color:#fff;}
.header-logos{display:flex;align-items:center;}
.header-logos img{height:45px;}

.card{background:white;padding:15px;border-radius:14px;box-shadow:var(--shadow);margin-bottom:20px;}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:end;}
.field{display:flex;flex-direction:column;font-size:12px;color:#64748b}
select,input{padding:8px;border-radius:8px;border:1px solid #cbd5e1;min-width:180px}
button{background:#2563eb;color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer}
button.secondary{background:#e2e8f0;color:#0f172a}

.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;margin-bottom:20px;}
.kpi{background:linear-gradient(135deg,#2563eb,#0ea5e9);color:white;padding:15px;border-radius:12px;}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:15px;}

table{width:100%;border-collapse:collapse;font-size:13px}
th{background:#2563eb;color:white;padding:8px;text-align:left}
td{padding:8px;border-top:1px solid #e2e8f0}
a{color:#0f172a;text-decoration:none;font-weight:600}
a:hover{color:#2563eb;text-decoration:underline}

#status{margin-top:10px;font-size:12px;color:#475569}
.small-note{font-size:12px;color:#64748b;margin-top:6px}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <div class="header-title">Clipping Detran-MA</div>
    <div class="header-logos">
      <img src="logos.png" alt="Logos Detran/MA">
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <div class="field">Busca por assunto<input id="busca" placeholder="Digite e clique Filtrar"></div>
      <div class="field">Data inicial<input type="date" id="dataIni"></div>
      <div class="field">Data final<input type="date" id="dataFim"></div>
      <div class="field">Impacto<select id="fImpacto"></select></div>
      <div class="field">Veículos<select id="fVeiculo"></select></div>
      <div class="field">Local (praça)<select id="fPraca"></select></div>
      <button id="btnCarregar">Carregar</button>
      <button class="secondary" id="btnFiltrar">Filtrar</button>
      <button class="secondary" id="btnLimpar">Limpar</button>
    </div>
    <div id="status"></div>
  </div>

  <div class="kpis">
    <div class="kpi">Total<br><h2 id="kTotal">0</h2></div>
    <div class="kpi"><span id="kImpactoLabel">Porcentagem Positiva</span><br><h2 id="kImpactoPct">0%</h2></div>
    <div class="kpi">Veículo de comunicação<br><h2 id="kVeiculo">-</h2></div>
    <div class="kpi">Assunto relacionado<br><h2 id="kTopico">-</h2></div>
  </div>

  <div class="grid">
    <div class="card"><canvas id="gImpacto"></canvas></div>
    <div class="card"><canvas id="gTopico"></canvas></div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:end;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
      <h3 style="margin:0;">Lista de matérias</h3>

      <!-- ✅ Seletor de data da LISTA (substitui ordenação) -->
      <div class="field" style="min-width:220px;">
        <label>Data (lista)</label>
        <select id="fDataLista"></select>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Título</th>
          <th>Data</th>
          <th>Veículo</th>
          <th>Impacto</th>
          <th>Local (praça)</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>

    <div class="small-note">Dica: use “Data inicial” e “Data final” para período e “Data (lista)” para ver um dia específico.</div>
  </div>

</div>

<script>
const URL_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vTQDEoRILXzO3X3rUuRZJV8VaMFuxgiyaqqJbVe7wpEeOxYkoTV1Tl9oWNyK9z4vxCSCdI0Yrbxve_6/pub?gid=553568239&single=true&output=csv";

let dados=[], base=[], filtrados=[], charts={};

// nomes reais das colunas detectadas no CSV (evita problema do Local)
let COL = {
  titulo: "Título",
  data: "Data",
  topico: "Tópico",
  impacto: "Impacto",
  veiculo: "Veículo",
  praca: "Local (praça)",
  link: "Link"
};

const $ = (id)=>document.getElementById(id);

function setStatus(msg){ $("status").innerHTML = msg || ""; }

// Normalização
function norm(v){
  return (v ?? "")
    .toString()
    .replace(/\uFEFF/g,"")   // BOM
    .replace(/\u00A0/g," ")  // espaço duro
    .trim();
}
function normCmp(v){ return norm(v).toLowerCase(); }
function stripAccents(s){
  return norm(s).normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function keyNorm(s){
  return stripAccents(s).toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9]/g,"");
}

// Detecta colunas reais do CSV mesmo com variações
function detectColumns(fields){
  const f = (fields || []).map(x => ({ raw:x, k:keyNorm(x) }));
  const find = (...alts)=>{
    for(const alt of alts){
      const a = keyNorm(alt);
      const exact = f.find(x => x.k === a);
      if(exact) return exact.raw;
      const contain = f.find(x => x.k.includes(a) || a.includes(x.k));
      if(contain) return contain.raw;
    }
    return null;
  };

  return {
    titulo:  find("titulo","título","materia","matéria","noticia","notícia") || COL.titulo,
    data:    find("data","date") || COL.data,
    topico:  find("topico","tópico","assunto","tema") || COL.topico,
    impacto: find("impacto","sentimento") || COL.impacto,
    veiculo: find("veiculo","veículo","fonte","midia","mídia") || COL.veiculo,
    praca:   find("local(praca)","localpraca","praca","praça","local") || COL.praca,
    link:    find("link","url","endereco","endereço") || COL.link
  };
}

// Parse de data dd/mm/aaaa e fallback
function parseData(s){
  const v = norm(s);
  if(!v) return null;
  const p = v.split("/");
  if(p.length===3){
    const d = new Date(parseInt(p[2],10), parseInt(p[1],10)-1, parseInt(p[0],10));
    return isNaN(d) ? null : d;
  }
  const d = new Date(v);
  return isNaN(d) ? null : d;
}

// Preenche selects (Impacto/Veículo/Praça)
function preencherFiltros(){
  const impacts=[...new Set(dados.map(d=>norm(d[COL.impacto])).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
  $("fImpacto").innerHTML = "<option value=''>Todos</option>" + impacts.map(v=>`<option value="${escapeAttr(v)}">${escapeHtml(v)}</option>`).join("");

  const veics=[...new Set(dados.map(d=>norm(d[COL.veiculo])).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
  $("fVeiculo").innerHTML = "<option value=''>Todos</option>" + veics.map(v=>`<option value="${escapeAttr(v)}">${escapeHtml(v)}</option>`).join("");

  // ✅ Local (praça) agora usa a coluna detectada (COL.praca)
  const pracs=[...new Set(dados.map(d=>norm(d[COL.praca])).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
  $("fPraca").innerHTML = "<option value=''>Todos</option>" + pracs.map(v=>`<option value="${escapeAttr(v)}">${escapeHtml(v)}</option>`).join("");
}

// Seletor “Data (lista)” (somente lista)
function atualizarSelectDataLista(){
  const el = $("fDataLista");
  const selecionada = el.value;

  const datas = [...new Set(filtrados.map(d => norm(d[COL.data])).filter(Boolean))]
    .sort((a,b)=> (parseData(b)?.getTime()||0) - (parseData(a)?.getTime()||0)); // datas mais recentes primeiro na lista

  el.innerHTML = "<option value=''>Todas</option>" + datas.map(dt=>`<option value="${escapeAttr(dt)}">${escapeHtml(dt)}</option>`).join("");

  // preserva seleção se ainda existir
  if(selecionada && datas.includes(selecionada)){
    el.value = selecionada;
  }else{
    el.value = "";
  }
}

// Cálculos
function contar(arr,col){
  const c={};
  arr.forEach(d=>{
    const v = norm(d[col]) || "Sem";
    c[v]=(c[v]||0)+1;
  });
  return c;
}
function topItem(o){
  return Object.entries(o).sort((a,b)=>b[1]-a[1])[0]?.[0] || "-";
}

// Render geral (KPIs/gráficos) + tabela (com filtro “Data (lista)”)
function render(){
  $("kTotal").innerText = filtrados.length;

  const impSel = norm($("fImpacto").value) || "Positivo";
  const pct = Math.round((contar(base, COL.impacto)[impSel]||0)/(base.length||1)*100);
  $("kImpactoLabel").innerText = "% " + impSel;
  $("kImpactoPct").innerText = pct + "%";

  $("kVeiculo").innerText = topItem(contar(filtrados, COL.veiculo));
  $("kTopico").innerText  = topItem(contar(filtrados, COL.topico));

  // Gráficos
  if(charts.i) charts.i.destroy();
  charts.i=new Chart($("gImpacto"),{
    type:"pie",
    data:{
      labels:Object.keys(contar(filtrados, COL.impacto)),
      datasets:[{data:Object.values(contar(filtrados, COL.impacto))}]
    }
  });

  if(charts.t) charts.t.destroy();
  charts.t=new Chart($("gTopico"),{
    type:"bar",
    data:{
      labels:Object.keys(contar(filtrados, COL.topico)),
      datasets:[{data:Object.values(contar(filtrados, COL.topico))}]
    },
    options:{scales:{y:{beginAtZero:true}}}
  });

  // ✅ Atualiza opções do seletor de data da LISTA
  atualizarSelectDataLista();

  // ✅ Aplica seleção de data SOMENTE na lista
  const dataLista = norm($("fDataLista").value);
  const lista = dataLista ? filtrados.filter(d => norm(d[COL.data]) === dataLista) : filtrados;

  // Tabela
  $("tb").innerHTML = lista.map(d=>`
    <tr>
      <td><a href="${escapeAttr(norm(d[COL.link]))}" target="_blank" rel="noopener">${escapeHtml(norm(d[COL.titulo]))}</a></td>
      <td>${escapeHtml(norm(d[COL.data]))}</td>
      <td>${escapeHtml(norm(d[COL.veiculo]))}</td>
      <td>${escapeHtml(norm(d[COL.impacto]))}</td>
      <td>${escapeHtml(norm(d[COL.praca]))}</td>
    </tr>
  `).join("") || `<tr><td colspan="5">Sem dados</td></tr>`;
}

function filtrar(){
  const b  = normCmp($("busca").value);
  const vi = normCmp($("fVeiculo").value);
  const pr = normCmp($("fPraca").value);
  const im = normCmp($("fImpacto").value);

  const di = $("dataIni").value ? new Date($("dataIni").value+"T00:00:00") : null;
  const df = $("dataFim").value ? new Date($("dataFim").value+"T23:59:59") : null;

  base = dados.filter(d=>{
    const titulo = normCmp(d[COL.titulo]);
    const dt = parseData(d[COL.data]);
    const veiculo = normCmp(d[COL.veiculo]);
    const praca = normCmp(d[COL.praca]);

    const okBusca   = !b  || titulo.includes(b);
    const okVeiculo = !vi || veiculo === vi;
    const okPraca   = !pr || praca === pr;

    const okData =
      (!di && !df) ? true :
      (!dt) ? false :
      (!di || dt >= di) && (!df || dt <= df);

    return okBusca && okVeiculo && okPraca && okData;
  });

  filtrados = base.filter(d=>{
    const impacto = normCmp(d[COL.impacto]);
    return !im || impacto === im;
  });

  render();
}

function limpar(){
  $("busca").value="";
  $("dataIni").value="";
  $("dataFim").value="";
  $("fImpacto").value="";
  $("fVeiculo").value="";
  $("fPraca").value="";
  $("fDataLista").value="";
  filtrar();
}

function carregar(){
  setStatus("Carregando dados…");
  Papa.parse(URL_CSV,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:r=>{
      // Detecta colunas reais do CSV
      COL = detectColumns(r.meta && r.meta.fields ? r.meta.fields : Object.keys((r.data||[{}])[0] || {}));
      console.log("Colunas detectadas:", COL);

      dados = (r.data || []).filter(x => norm(x[COL.titulo]).length > 0);
      preencherFiltros();
      filtrar();

      setStatus(`Dados carregados: <b>${dados.length}</b> matérias.`);
    },
    error: err=>{
      console.error(err);
      setStatus("Erro ao carregar o CSV. Verifique se o link está público e publicado como CSV.");
    }
  });
}

// Eventos
$("btnCarregar").onclick = carregar;
$("btnFiltrar").onclick = filtrar;
$("btnLimpar").onclick = limpar;

// Quando mudar a “Data (lista)”, só atualiza a tabela (sem recalcular tudo)
$("fDataLista").addEventListener("change", ()=>render());

// Escape seguro
function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("`","&#096;");
}
</script>
</body>
</html>
