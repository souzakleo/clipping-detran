<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Clipping Detran-MA</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
--bg:#eef2f7; --card:#fff; --text:#0f172a; --muted:#64748b;
--primary:#2563eb; --primary2:#0ea5e9; --border:#cbd5e1;
--shadow:0 6px 18px rgba(2,6,23,.08); --radius:14px;
}
body{margin:0;padding:20px;font-family:Segoe UI;background:var(--bg);}
.container{max-width:1750px;margin:auto;}

.header{
background:linear-gradient(135deg,#1e40af,#0ea5e9);
color:white;
padding:18px 20px;
border-radius:14px;
box-shadow:var(--shadow);
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}

.header-title{
font-size:24px;
font-weight:700;
color:#1e40af;
}

.header-logos img{
height:45px;
}

.card{background:white;padding:15px;border-radius:14px;box-shadow:var(--shadow);margin-bottom:20px;}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:end;}
.field{display:flex;flex-direction:column;font-size:12px;color:#64748b}
select,input{padding:8px;border-radius:8px;border:1px solid #cbd5e1}

button{background:#2563eb;color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer}
button.secondary{background:#e2e8f0;color:#0f172a}

.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;margin-bottom:20px;}
.kpi{background:linear-gradient(135deg,#2563eb,#0ea5e9);color:white;padding:15px;border-radius:12px;}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:15px;}

table{width:100%;border-collapse:collapse;font-size:13px}
th{background:#2563eb;color:white;padding:8px}
td{padding:8px;border-top:1px solid #e2e8f0}
a{color:#0f172a;text-decoration:none;font-weight:600}
a:hover{color:#2563eb;text-decoration:underline}
</style>
</head>

<body>
<div class="container">

<div class="header">
<div class="header-title">Clipping Detran-MA</div>
<div class="header-logos">
<img src="logos.png">
</div>
</div>

<div class="card">
<div class="controls">
<div class="field">Buscar<input id="busca"></div>
<div class="field">Data inicial<input type="date" id="dataIni"></div>
<div class="field">Data final<input type="date" id="dataFim"></div>
<div class="field">Impacto<select id="fImpacto"></select></div>
<div class="field">Veículos<select id="fVeiculo"></select></div>
<div class="field">Local<select id="fPraca"></select></div>
<button id="btnCarregar">Carregar</button>
<button class="secondary" id="btnFiltrar">Filtrar</button>
<button class="secondary" id="btnLimpar">Limpar</button>
</div>
<div id="status"></div>
</div>

<div class="kpis">
<div class="kpi">Total<br><h2 id="kTotal">0</h2></div>
<div class="kpi"><span id="kImpactoLabel">% Positivas</span><br><h2 id="kImpactoPct">0%</h2></div>
<div class="kpi">Top Veículo<br><h2 id="kVeiculo">-</h2></div>
<div class="kpi">Top Tópico<br><h2 id="kTopico">-</h2></div>
</div>

<div class="grid">
<div class="card"><canvas id="gImpacto"></canvas></div>
<div class="card"><canvas id="gTopico"></canvas></div>
</div>

<div class="card">

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
<h3>Lista de matérias</h3>
<button id="btnOrdenar" class="secondary">Mais recente ↓</button>
</div>

<table>
<thead>
<tr>
<th>Título</th>
<th>Data</th>
<th>Veículo</th>
<th>Impacto</th>
<th>Local</th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>
</div>

</div>

<script>

const URL_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vTQDEoRILXzO3X3rUuRZJV8VaMFuxgiyaqqJbVe7wpEeOxYkoTV1Tl9oWNyK9z4vxCSCdI0Yrbxve_6/pub?gid=553568239&single=true&output=csv";

let dados=[],base=[],filtrados=[],ordemDesc=true,charts={};

function norm(v){return (v||"").trim();}
function parseData(s){const p=s.split("/");if(p.length===3)return new Date(p[2],p[1]-1,p[0]);return new Date(s)}

function carregar(){
Papa.parse(URL_CSV,{download:true,header:true,skipEmptyLines:true,complete:r=>{
dados=r.data.filter(x=>norm(x["Título"]));
preencher();
filtrar();
}});
}

function preencher(){
["Impacto","Veículo","Local (praça)"].forEach(c=>{
const id=c.includes("Local")?"fPraca":c==="Veículo"?"fVeiculo":"fImpacto";
const vals=[...new Set(dados.map(d=>norm(d[c])).filter(Boolean))];
document.getElementById(id).innerHTML="<option value=''>Todos</option>"+vals.map(v=>`<option>${v}</option>`).join("");
});
}

function filtrar(){
const b=busca.value.toLowerCase();
const vi=fVeiculo.value;
const pr=fPraca.value;
const im=fImpacto.value;
const di=dataIni.value?new Date(dataIni.value):null;
const df=dataFim.value?new Date(dataFim.value):null;

base=dados.filter(d=>{
const dt=parseData(d.Data);
return (!b||d.Título.toLowerCase().includes(b))&&(!vi||d["Veículo"]===vi)&&(!pr||d["Local (praça)"]===pr)&&(!di||dt>=di)&&(!df||dt<=df);
});

filtrados=base.filter(d=>!im||d.Impacto===im);
render();
}

function limpar(){busca.value="";dataIni.value="";dataFim.value="";fImpacto.value="";fVeiculo.value="";fPraca.value="";filtrar();}

function contar(arr,col){const c={};arr.forEach(d=>{const v=d[col]||"Sem";c[v]=(c[v]||0)+1});return c;}
function topItem(o){return Object.entries(o).sort((a,b)=>b[1]-a[1])[0]?.[0]||"-";}

function render(){

filtrados.sort((a,b)=>{
const da=parseData(a.Data)?.getTime()||0;
const db=parseData(b.Data)?.getTime()||0;
return ordemDesc?(db-da):(da-db);
});

kTotal.innerText=filtrados.length;
const impSel=fImpacto.value||"Positivo";
const pct=Math.round((contar(base,"Impacto")[impSel]||0)/(base.length||1)*100);
kImpactoLabel.innerText="% "+impSel;kImpactoPct.innerText=pct+"%";
kVeiculo.innerText=topItem(contar(filtrados,"Veículo"));
kTopico.innerText=topItem(contar(filtrados,"Tópico"));

if(charts.i)charts.i.destroy();
charts.i=new Chart(gImpacto,{type:"pie",data:{labels:Object.keys(contar(filtrados,"Impacto")),datasets:[{data:Object.values(contar(filtrados,"Impacto"))}]}});

if(charts.t)charts.t.destroy();
charts.t=new Chart(gTopico,{type:"bar",data:{labels:Object.keys(contar(filtrados,"Tópico")),datasets:[{data:Object.values(contar(filtrados,"Tópico"))}]}});

tb.innerHTML=filtrados.map(d=>`
<tr>
<td><a href="${d.Link}" target="_blank">${d.Título}</a></td>
<td>${d.Data}</td>
<td>${d["Veículo"]}</td>
<td>${d.Impacto}</td>
<td>${d["Local (praça)"]}</td>
</tr>`).join("");
}

btnCarregar.onclick=carregar;
btnFiltrar.onclick=filtrar;
btnLimpar.onclick=limpar;

btnOrdenar.onclick=()=>{
ordemDesc=!ordemDesc;
btnOrdenar.innerText=ordemDesc?"Mais recente ↓":"Mais antigo ↑";
render();
};

</script>
</body>
</html>

